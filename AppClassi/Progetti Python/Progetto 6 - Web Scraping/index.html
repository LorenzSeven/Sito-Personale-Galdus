<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
  <script>const theme = localStorage.getItem('theme'); document.documentElement.setAttribute('data-theme', theme);</script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
  integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="../../css/stilePaginaProgetto.css">
  <link rel="icon" type="image/x-icon" href="../../img/icona-python.png">
  <title>Wev Scraping</title>
  <meta charset="UTF-8">
</head>

<body>
  <a href="../../python.html" class="exit">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Esci dal Progetto</a>
  <div class="form-check form-switch switch">
    <input class="form-check-input" name="toggleChk" type="checkbox" role="switch" id="flexSwitchCheckChecked"
      onchange="luminosita()">
    <label class="form-check-label" id="Etichetta" for="flexSwitchCheckChecked">
      <svg class="contenitoreLuminosita"><desc>Sole e Luna</desc><!--Contenitore immagini sovrapposte-->
        <image class="luminositaNotte" href="../../img/imgProgetto/luna-bianca.png"></image>
        <image class="luminositaGiorno" href="../../img/imgProgetto/sole-nero.png"></image>  
      </svg>
    </label>
  </div>
  <h1 class="titolo" id="titoloPagina">Web Scraping</h1>

  <div class="testo">
    <div id="contenitoreCopiaTesto" class="contenitoreCopiaTesto"><!--DA CAMBIARE IN CASO CE NE SONO MOLTI-->
      <button id="pulsanteCopia" class="pulsanteCopia" onclick="copiaTesto()"><!--DA CAMBIARE IN CASO CE NE SONO MOLTI-->
        <svg class="contenitoreIcona"><desc>Clipboard</desc> <!--Contenitore immagini sovrapposte-->
          <image class="iconaNotte" href="../../img/imgProgetto/clipboard-bianca.png"></image>
          <image class="iconaGiorno" href="../../img/imgProgetto/clipboard-nera.png"></image>                            
        </svg>Copia Testo
      </button>    
      <div id="divTestoCopiato" class="divTestoCopiato"><!--DA CAMBIARE IN CASO CE NE SONO MOLTI-->
				<svg class="contenitoreIcona"><desc>Spunta</desc> <!--Contenitore immagini sovrapposte-->
					<image class="iconaNotte" href="../../img/imgProgetto/spunta-bianca.png"></image>
					<image class="iconaGiorno" href="../../img/imgProgetto/spunta-nera.png"></image>                             
        </svg>testo Copiato!
      </div>
    </div>    
      <pre id="testoDaCopiare" class="testoDaCopiare"><!--DA CAMBIARE IN CASO CE NE SONO MOLTI-->
import bs4, requests, os, pandas
#installare anche la libreria openpyxl e xlsxwriter anche se non si vedono dichiarate nel codice
#lavorano entrambi con pandas nella conversione da csv a xlsx
#per installare una libreria scrivere: pip install (nome della libreria)
#Web Scraping sul sito Subito.it

#definizione funzione: verifica la connessione al sito
def verificaConnessioneSito(link):
    try:                                                        #prova a eseguire il codice seguente
        response = requests.get(link)                           #fa la richiesta di prendere l'html dal link
        response.raise_for_status()                             #verifica se il sito risponde correttamente con stato 200
        print("Tutto okay, il sito risponde correttamente")     #stampa tutto okay
        return True                                             #ritorna True
    except requests.exceptions.RequestException as e:           #altrimenti c'è un eccezione e
        if "HTTPSConnection" in str(e):                         #se trovi la stringa "HTTPSConnection" nell'eccezione e
            print("La connessione a Internet è assente")        #stampa la connessione a Internet è assente
        else:                                                   #altrimenti
            print("Si è verificato un errore durante la richiesta:", e) #stampa l'eccezione
    return False                                                #ritorna False

#definizione funzione: prende i dati dal link della pagina
def prendiDati(link, nomeFile):
    soup = bs4.BeautifulSoup(requests.get(link).text, 'html.parser' )     #prende tutto l'html della pagina web
    classe_div_annunci = 'ListingContainer_col__1TZpb ListingContainer_items__3lMdo col items' #classe del div che contiene tutti gli annunci
    div_annunci_tag = soup.find('div', classe_div_annunci)      #prende l'elemento div con la classe specificata

    #recupero link
    classe_a_link = 'SmallCard-module_link__hOkzY'              #classe del link annuncio
    a_link_tag = div_annunci_tag.find_all('a', classe_a_link)   #prende tutti i tag a con la classe specificata
    href_annunci = []                                           #dichiara la lista href_annunci
    for href_annuncio in a_link_tag:                            #per ogni href_annuncio nella lista a_link_tag
        link_annuncio = str(href_annuncio.get('href'))          #prende l'href
        href_annunci.append(link_annuncio)                      #aggiungi alla lista href_annunci

    #recupero titolo oggetto
    classe_h2_titolo = 'index-module_sbt-text-atom__ed5J9 index-module_token-h6__FGmXw size-normal index-module_weight-semibold__MWtJJ ItemTitle-module_item-title__VuKDo SmallCard-module_item-title__1y5U3' #classe del titolo h2
    h2_titolo_tag = div_annunci_tag.find_all('h2', classe_h2_titolo)  #prende tutti i tag h2 con la classe specificata
    titoli = []                                                 #dichiaro la lista titoli
    for titolo in h2_titolo_tag:                                #per ogni titolo nella lista h2_titolo_tag
        titolo_annuncio = titolo.text                           #prende il testo del titolo
        titoli.append(titolo_annuncio)                          #aggiungi alla lista titoli

    #recupero luogo e data(la data è differente dal sito di 1 o di 2 ore, per via del fuso orario) 
    classe_div_luogo_data = 'PostingTimeAndPlace-module_date-location__1Owcv index-module_container__noDE3' #classe div luogo e data
    classe_div_completo = 'SmallCard-module_item-key-data__fcbjY'               #classe del div che contiene: titolo, data e luogo, prezzo e spedizione
    div_completo_tag = div_annunci_tag.find_all('div', classe_div_completo)     #prende tutti i tag div con la classe specificata

    luoghi_date = []  
    for indice in range(len(div_completo_tag)):
        elemento_div_completo_tag = div_completo_tag[indice]                    #seleziona il div completo corrente
        if elemento_div_completo_tag.find('div', classe_div_luogo_data):        #se dentro il div completo esiste l'elemento div con classe specificata
            elemento_div_luogo_data_tag = elemento_div_completo_tag.find('div', classe_div_luogo_data) #prende l'elemento div con classe specificata
            luogo_data_annuncio = elemento_div_luogo_data_tag.text              #prende il testo del luogo e data
            nuovo_luogo_data_annuncio = luogo_data_annuncio.replace(")", ") " ) #sostituisce la stringa ")" con ") ", aggiunge uno spazio dopo la parentesi
            if nuovo_luogo_data_annuncio[-1].isdigit() == False:                #se l'ultimo carattere non è un numero
                luoghi_date.append(nuovo_luogo_data_annuncio + 'Data non disponibile') #aggiungi alla lista luoghi_date nuovo_luogo_data_annuncio + 'data non disponibile'
            else:                                                               #altrimenti
                luoghi_date.append(nuovo_luogo_data_annuncio)                   #aggiungi alla lista luoghi_date nuovo_luogo_data_annuncio
        else:                                                                   #altrimenti   
            luoghi_date.append("Luogo e Data non disponibili")                  #aggiungi alla lista luoghi_date "luogo e data non disponibili"

    #recupero prezzo e spedizione
    classe_p_prezzi_spedizioni = []
    classe_p_prezzi_spedizioni.append('index-module_price__N7M2x SmallCard-module_price__yERv7 index-module_small__4SyUf') #aggiunge la classe prezzo alla lista prezzi
    classe_p_prezzi_spedizioni.append('index-module_price__N7M2x SmallCard-module_price__yERv7 index-module_no-item-available-price__v7iwv index-module_badge-below__CtGle index-module_small__4SyUf')
    p_prezzo_spedizione_tag = div_annunci_tag.find_all('p', classe_p_prezzi_spedizioni) #prende tutti i tag p con le classi specificate                              

    prezzi = []                                                         #dichiara la lista prezzi
    spedizioni = []                                                     #dichiara la lista spedizioni

    for testo_prezzo_spedizione in p_prezzo_spedizione_tag:             #per ogni tag nella lista p_prezzo_spedizione_tag
        prezzo_spedizione_annuncio = testo_prezzo_spedizione.text       #prende il testo dall'elemento p_prezzo_spedizione_tag
        if len(prezzo_spedizione_annuncio) == 0:                        #se la lunghezza della stringa prezzo_spedizione_annuncio è 0
            prezzi.append("Prezzo non disponibile")                     #aggiunge il prezzo non disponibile nell'array prezzi
            spedizioni.append("Spedizione non disponibile")             #aggiunge la spedizione non disponibile nell'array spedizioni
        elif len(prezzo_spedizione_annuncio) > 0:                       #se la lunghezza della stringa prezzo_spedizione_annuncio è maggiore di 0 

            #prezzo
            carattere_euro = "€"                                        #dichiara la variabile stringa carattere_euro 
            if carattere_euro in prezzo_spedizione_annuncio:            #se il carattere è contenuto nella stringa prezzo_spedizione_annuncio
                indice_euro = prezzo_spedizione_annuncio.index('€')     #prende l'indice del carattere € nella stringa prezzo_spedizione_annuncio
                solo_prezzo = prezzo_spedizione_annuncio[0:(indice_euro-1)] #prende la sottostringa che va da 0 fino a indice_euro meno 1 carattere, perchè c'è uno spazio dopo il prezzo 
                prezzi.append(solo_prezzo + carattere_euro)             #aggiunga il prezzo + il carattere € alla lista prezzi 
            else:                                                       #altrimenti se non è contenuto 
                prezzi.append("Prezzo non disponibile")                 #aggiunge il prezzo non disponibile nell'array prezzi

            #spedizione
            stringa_spedizioni = "Spedizione disponibile"
            if stringa_spedizioni in prezzo_spedizione_annuncio:        #se la stringa "Spedizione disponibile" è presente in prezzo_spedizione_annuncio
                spedizioni.append("Spedizione disponibile")             #aggiunge "Spedizione disponibile" nell'array spedizioni
            else:                                                       #altrimenti se non è contenuto
                spedizioni.append("Spedizione non disponibile")                #aggiunge "Spedizione non disponibile" nell'array spedizioni

    
    #creo la lista di righe con l'intestazione e i dati dal sito
    lista_annunci = []
    lista_annunci.append("Titolo;Luogo e Data;Prezzo;Spedizione;Link Annuncio") #aggiunge intestazione colonne in lista_annunci
    for i in range(len(href_annunci)):                               #per i che va 0 fino alla lunghezza della lista href_annunci
        riga_elementi_liste = titoli[i], luoghi_date[i], prezzi[i], spedizioni[i], href_annunci[i] #aggiunge i dati nelle colonne in lista_annunci
        annuncio_riga_completa = ';'.join(riga_elementi_liste)       #unisci gli elementi in una stringa con delimitatore ";"
        lista_annunci.append(annuncio_riga_completa)                 #aggiungi la stringa in lista_annunci 

    
    #leggo i dati dal file 'risultati_salvati.csv' e creo una lista di righe del file
    nomeFileCSV = nomeFile + '.csv'
    fileCSV = open(nomeFileCSV, 'a')
    os.chmod(nomeFileCSV, 0o644)  # Assegna i permessi di lettura e scrittura del file
    lista_annunci_fileCSV = [riga.rstrip('\n') for riga in open(nomeFileCSV)] 
    #crea una lista chiamata lista_annunci_fileCSV di righe dal file 'risultati_salvati.csv' senza il carattere '\n'
    lista_ID_annunci = [riga[-13:-4] for riga in lista_annunci_fileCSV]
    #crea una lista chiamata lista_ID_annunci di righe dalla lista lista_annunci_fileCSV prendendo solo i caratteri dal 13°fino al 4° partendo dalla fine

    
    #scrivo i dati che ho trovato nel sito solo se non sono contenuti nel file 'risultati_salvati.csv'
    new_link_annunci = []                                           
    for riga_annuncio in lista_annunci:                             #per ogni elemento riga_annuncio della lista lista_annunci
        riga_ID_annuncio = riga_annuncio[-13:-4]                    #prendo l'ID annuncio dal carattere 13° fino al 4° partendo dalla fine
        if riga_ID_annuncio not in lista_ID_annunci:                #se riga_ID_annuncio non è contenuta nella lista_ID_annunci
            new_link_annunci.append(riga_annuncio)                  #allora aggiungo riga_annuncio alla lista new_link_annunci
            fileCSV.write('%s\n' %riga_annuncio)                    #e scrivo riga_annuncio nel file fileCSV
    fileCSV.close()                                                 #chiudi il fileCSV
    #fileCSV.write('%s\n' % riga_annuncio): significa che scrive all'interno del fileCSV, 
    #%s è un termine che sta per stringa e viene sostituito con il valore di riga_annuncio 
    #%s\n perciò indica una stringa e subito dopo aggiunge il carattere va a capo
    if len(new_link_annunci) > 0:                                   #se la lunghezza della lista new_link_annunci è maggiore di 0
        print('Ci sono nuovi risultati!')                           #stampa 'Ci sono nuovi risultati!'
        return True                                                 #altrimenti 
    print('Nessun nuovo annuncio.')                                 #stampa 'nessun nuovo annuncio.'
    return False


#definizione funzione: controllo se il pulsante pagina successiva è attivo
def controllaPulsantePagina(link, numeroPagina, nuoviDati):
    soup = bs4.BeautifulSoup(requests.get(link).text, 'html.parser' )       #prende tutto l'html della pagina web
    classe_button_pagina = 'index-module_sbt-button__hQMUx index-module_outline__reo8F index-module_medium__pYkH6 index-module_icon-only__gkRU8'
    lista_button_pagina_tag = soup.find_all('button', classe_button_pagina) #prende il button con la classe specificata
    secondo_button_pagina_tag = lista_button_pagina_tag[1]      #seleziono il 2°pulsante che ha la classe specificata
    
    #se è arrivato all'ultima pagina
    if secondo_button_pagina_tag.has_attr('disabled'):          #se il 2°pulsante ha l'attributo disabled
        if nuoviDati == True:                                   #se ci sono nuovi dati
            print("Finito, ho preso i dati dalla pagina " + str(numeroPagina) + ", ultima pagina")     #stampa Finito, ho preso i dati dall'ultima pagina
        return True                                             #ritorna True
    
    #se non è arrivato all'ultima pagina
    if nuoviDati == True:                                       #se ci sono nuovi dati
        print("Ho preso i dati dalla pagina " + str(numeroPagina))  #altrimenti stampa Ho preso i dati dalla pagina " + str(numeroPagina)
    return False                                                #ritorna False


#definizione funzione: converto il file csv in file xlsx, per una questione di lettura dati
def convertiFileCSVInXlsl(nomeFile):
    try:
        nomeFileCSV = nomeFile + '.csv'
        nomeFileXLSX = nomeFile + '.xlsx'

        #verifica se il file risultati_salvati.xlsx esiste
        fileExcel = False
        if os.path.exists(nomeFileXLSX):
            fileExcel = True

        # legge il file CSV nomeFileCSV utilizzando pandas, con delimitatore ';' e con encoding ISO-8859-1
        df = pandas.read_csv(nomeFileCSV, delimiter=';', encoding='ISO-8859-1') 
        #crea un oggetto ExcelWriter di pandas per scrivere i dati nel file nomeFileXLSX. Si specifica xlsxwriter come motore per la scrittura del file Excel.
        writer = pandas.ExcelWriter(nomeFileXLSX, engine='xlsxwriter')    
        #scrive i dati del DataFrame df nel file Excel utilizzando l'oggetto ExcelWriter
        #index=False per evitare di scrivere l'indice del DataFrame nel file Excel
        #specifica il nome del foglio in cui verranno scritti i dati (Foglio1)
        df.to_excel(writer, index=False, sheet_name='Foglio1')            
        workbook  = writer.book                                           # seleziona la cartella di lavoro excel
        worksheet = writer.sheets['Foglio1']                              # seleziona il 1°Foglio
    
        cell_format = workbook.add_format({'font_color': 'blue', 'underline': True})    #Aggiungi formattazione per rendere il link cliccabile
        worksheet.set_column('E:E', None, cell_format)              # Applica il formato alla colonna E che contiene i link

        # Definisci una formattazione condizionale: spessore bordo 1, colore bordo rosso acceso, colore sfondo cella rosso chiaro e testo rosso scuro
        formatoRosso = workbook.add_format({'border': 1, 'border_color': '#ff0000','bg_color': '#ffbdbd', 'font_color': '#870000'})
        # Definisci una formattazione condizionale: spessore bordo 1, colore bordo verde acceso, colore sfondo cella verde chiaro e testo verde scuro
        formatoVerde = workbook.add_format({'border': 1, 'border_color': '#00ff0a','bg_color': '#c2ffbd', 'font_color': '#035b00'})
        # Applica la formattazione condizionale alla colonna D, alle celle che contengono 'Spedizione non disponibile' e 'Spedizione disponibile'
        worksheet.conditional_format('D2:D1048576', {'type': 'text','criteria': 'containing','value': 'Spedizione non disponibile','format': formatoRosso})
        worksheet.conditional_format('D2:D1048576', {'type': 'text','criteria': 'containing','value': 'Spedizione disponibile','format': formatoVerde})
        worksheet.conditional_format('C2:C1048576', {'type': 'text','criteria': 'containing','value': 'Prezzo non disponibile','format': formatoRosso})

        # Adatta la larghezza delle colonne alla larghezza dei dati
        for col_num, value in enumerate(df.columns.values):  
            width = max(df[value].astype(str).map(len).max(), len(value))   #prende la lunghezza maggiore tra il titolo e i dati 
            worksheet.set_column(col_num, col_num, width)                   #allarga le colonne in base alla larghezza

        worksheet.freeze_panes(1, 0)        # Blocca la prima riga
        writer._save()  #chiude il writer e salva il file

        #se il file risultati_salvati.xlsx esiste
        if fileExcel == True:
            print("Ho aggiornato il file xlsx")
        else:
            print("Ho creato il file xlsx corrispettivo, per leggere meglio i dati")

    except PermissionError:
        print("Non è possibile convertire il file csv in xlsx perchè il file è aperto in Excel, chiudilo")



#-----------------------------------Prendi i risultati di ricerca di tutte le pagine---------------------------------------------------------
LINK = "https://www.subito.it/annunci-sardegna/vendita/sport/?q=tavola+da+surf"     #link 1°pagina 
controlloStatoSito = verificaConnessioneSito(LINK)                                  #controllo stato del sito
nomeFile = 'risultati_salvati'                                                      #nome del file che conterrà i dati

if controlloStatoSito == True:                                                      #se il sito risponde correttamente
    numeroPagina = 1                                                                #dichiara la variabile numeroPagina                                              
    nuoviDati = prendiDati(LINK, nomeFile)                                          #parte la funzione prendi_dati per LINK
    verificaStatoPulsante = controllaPulsantePagina(LINK, numeroPagina, nuoviDati)  #verifica lo stato del pulsante

    while(verificaStatoPulsante == False):                                          #finchè verificaStatoPulsante è False
        numeroPagina += 1                                                           #aumenta numeroPagina di 1
        LINKMULTIPAGINE = LINK + "&o=" +  str(numeroPagina)                         #link altre pagine successive alla 1° 
        nuoviDati = prendiDati(LINKMULTIPAGINE, nomeFile)                           #parte la funzione prendi_dati per LINKMULTIPAGINE
        verificaStatoPulsante = controllaPulsantePagina(LINKMULTIPAGINE, numeroPagina, nuoviDati) #verifica lo stato del pulsante

    convertiFileCSVInXlsl(nomeFile)                                                 #crea un file xlsx dal file csv
    print("Programma finito")

	    </pre>
    </div>

    <div class="testo">
      <div id="contenitoreCopiaTesto2" class="contenitoreCopiaTesto"><!--DA CAMBIARE IN CASO CE NE SONO MOLTI-->
        <button id="pulsanteCopia2" class="pulsanteCopia" onclick="copiaTesto2()"><!--DA CAMBIARE IN CASO CE NE SONO MOLTI-->
          <svg class="contenitoreIcona"><desc>Clipboard</desc> <!--Contenitore immagini sovrapposte-->
            <image class="iconaNotte" href="../../img/imgProgetto/clipboard-bianca.png"></image>
            <image class="iconaGiorno" href="../../img/imgProgetto/clipboard-nera.png"></image>                            
          </svg>Copia Testo
        </button>    
        <div id="divTestoCopiato2" class="divTestoCopiato"><!--DA CAMBIARE IN CASO CE NE SONO MOLTI-->
          <svg class="contenitoreIcona"><desc>Spunta</desc> <!--Contenitore immagini sovrapposte-->
            <image class="iconaNotte" href="../../img/imgProgetto/spunta-bianca.png"></image>
            <image class="iconaGiorno" href="../../img/imgProgetto/spunta-nera.png"></image>                             
          </svg>testo Copiato!
        </div>
      </div>    
        <pre id="testoDaCopiare2" class="testoDaCopiare"><!--DA CAMBIARE IN CASO CE NE SONO MOLTI-->
import bs4, requests, os, pandas
#installare anche la libreria openpyxl e xlsxwriter
#lavorano entrambi con pandas nella conversione da csv a xlsx
#per installare una libreria scrivere: pip install (nome della libreria)
#Web Scraping sul sito Virgilio.it

#definizione funzione: verifica la connessione al sito
def verificaConnessioneSito(link):
    try:                                                        #prova a eseguire il codice seguente
        response = requests.get(link)                           #fa la richiesta di prendere l'html dal link
        response.raise_for_status()                             #verifica se il sito risponde correttamente con stato 200
        print("Tutto okay, il sito risponde correttamente")     #stampa tutto okay
        return True                                             #ritorna True
    except requests.exceptions.RequestException as e:           #altrimenti c'è un eccezione e
        if "HTTPSConnection" in str(e):                         #se trovi la stringa "HTTPSConnection" nell'eccezione e
            print("La connessione a Internet è assente")        #stampa la connessione a Internet è assente
        else:                                                   #altrimenti
            print("Si è verificato un errore durante la richiesta:", e) #stampa l'eccezione
    return False                                                #ritorna False

#definizione funzione: prende i dati dal link della pagina
def prendiDati(link, nomeFile):
    response = requests.get(link)                                         #fa la richiesta di prendere l'html dal link
    response_content_decoded = response.content.decode('UTF-8')           #codifica il testo in UTF-8
    soup = bs4.BeautifulSoup(response_content_decoded, 'html.parser')     #prende tutto l'html della pagina web
    ul_element_tag = soup.find('ul', {'itemtype': 'http://schema.org/ItemList'})    # Trova l'elemento <ul> con l' attributo specificato

    #recupero link
    classe_a_link = 'osr24 c2'                                  #classe del link impresa
    a_link_tag = ul_element_tag.find_all('a', classe_a_link)    #prende tutti i tag a con la classe specificata
    href_imprese = []                                           #dichiara la lista href_imprese
    for href_impresa in a_link_tag:                             #per ogni href_impresa nella lista a_link_tag
        link_impresa = str(href_impresa.get('href'))            #prende l'href
        href_imprese.append(link_impresa)                       #aggiungi alla lista href_imprese

    #recupero nome azienda
    classe_a_link = 'osr24 c2'                                          #classe del nome impresa a
    a_nome_azienda_tag = ul_element_tag.find_all('a', classe_a_link)    #prende tutti i tag a con la classe specificata
    nomi_imprese = []                                                   #dichiara la lista nomi_imprese
    for nome_azienda in a_nome_azienda_tag:                             #per ogni nome_azienda nella lista a_nome_azienda_tag
        testo_nome_azienda = str(nome_azienda.get('title'))             #prende il testo del nome_azienda
        nomi_imprese.append(testo_nome_azienda)                         #aggiungi alla lista nomi_imprese

    #recupero categoria azienda
    classe_a_link = 'osr11 c8'                                              #classe della categoria azienda
    a_categoria_azienda_tag = ul_element_tag.find_all('a', classe_a_link)   #prende tutti i tag a con la classe specificata
    categorie_imprese = []                                                  #dichiara la lista titoli
    for categoria_azienda in a_categoria_azienda_tag:                       #per ogni categoria_azienda nella lista categorie_imprese
        testo_categoria_azienda = str(categoria_azienda.get('title'))       #prende il testo di categoria_azienda
        categorie_imprese.append(testo_categoria_azienda)                   #aggiungi alla lista categorie_imprese

    #recupero indirizzo azienda
    classe_div_indirizzo_azienda = []
    classe_div_indirizzo_azienda.append('vcard indirizzo_azienda osr14')    #classe del div indirizzo_azienda 
    classe_div_indirizzo_azienda.append('indirizzo_azienda osr14')          #classe del div indirizzo_azienda
    div_indirizzo_azienda_tag = ul_element_tag.find_all('div', classe_div_indirizzo_azienda)  #prende tutti i tag div con la classe specificata
    indirizzi_imprese = []                                                  #dichiara la lista indirizzi_imprese
    for indirizzo_azienda in div_indirizzo_azienda_tag:                     #per ogni indirizzo_azienda nella lista div_indirizzo_azienda_tag                              
        testo_indirizzo_azienda = indirizzo_azienda.text                    #prende il testo dell'elemento indirizzo_azienda
        #pulisce il testo dai caratteri '\n', '\t', '\r' e sostituisce il carattere '-' con la stringa '- '
        testo_pulito = testo_indirizzo_azienda.replace('\n', '').replace('\t', '').replace('\r', '').replace('-', '- ')
       
        ultimo_numero_indice = 0                                            #dichiaro la variabile ultimo_numero_indice
        for carattere in reversed(testo_pulito):                            #scorre la stringa al contrario, cioè dalla fine all'inizio
            if carattere.isdigit():                                         #se un carattere è un numero
                ultimo_numero_indice = testo_pulito.rindex(carattere)       #prende l'indice del primo numero che incontra partendo dalla fine
                break                                                       #stop
        #prende la stringa da 0 fino all'indice del numero + 1, aggiunge la stringa ', ' + prende la stringa dall'indice del numero + 1 fino alla fine della stringa
        testo_separato = testo_pulito[0:ultimo_numero_indice + 1] + ', ' + testo_pulito[ultimo_numero_indice + 1: len(testo_pulito)]
        indirizzi_imprese.append(testo_separato)                            #aggiungi alla lista indirizzi_imprese


    #recupero descrizione azienda
    classe_p_descrizione_azienda = 'descrizione_azienda osr13 c7'                   #classe p descrizione azienda
    classe_div_completo = 'anagrafica_azienda'                                      #classe div completo
    div_completo_tag = ul_element_tag.find_all('div', classe_div_completo)          #prende tutti i tag div con la classe specificata
    descrizioni_imprese = []                                                        #dichiaro la lista descrizioni_imprese

    for indice in range(len(div_completo_tag)):
        elemento_div_completo_tag = div_completo_tag[indice]                         #seleziona il div completo corrente
        if elemento_div_completo_tag.find('p', classe_p_descrizione_azienda):        #se dentro il div completo esiste l'elemento div con classe specificata
            elemento_p_descrizione_azienda_tag = elemento_div_completo_tag.find('p', classe_p_descrizione_azienda) #prende l'elemento p con classe specificata
            testo_descrizione_azienda = elemento_p_descrizione_azienda_tag.text      #prende il testo del titolo
            testo_pulito = testo_descrizione_azienda.replace('\n', '').replace('\t', '').replace('\r', '') #pulisce il testo dai caratteri '\n', '\t', '\r'
            descrizioni_imprese.append(testo_pulito)                                 #aggiungi alla lista titoli
        else:                                                                        #altrimenti
            descrizioni_imprese.append("Descrizione Impresa non disponibile")        #aggiungi Descrizione Impresa non disponibile


    #recupero numero di telefono azienda
    classe_li_numero_telefono_azienda = 'num_tel ossb18 c2 hide'                                       #classe del numero azienda
    li_numero_telefono_azienda_tag = ul_element_tag.find_all('li', classe_li_numero_telefono_azienda)  #prende tutti i tag li con la classe specificata
    numeri_telefono_imprese = []                                                                       #dichiaro la lista numeri_telefono_imprese
    for numero_telefono_azienda in li_numero_telefono_azienda_tag:                                     #per ogni numero_telefono_azienda nella lista li_numero_telefono_azienda_tag
        testo_numero_telefono_azienda = numero_telefono_azienda.text                                   #prende il testo del numero azienda
        numeri_telefono_imprese.append(testo_numero_telefono_azienda)                                  #aggiungi alla lista numeri_telefono_imprese      

    #creo la lista di righe con l'intestazione e i dati dal sito
    lista_imprese = []
    lista_imprese.append("nome impresa;categoria impresa;indirizzo impresa;numero impresa;descrizione impresa;link impresa") #aggiunge intestazione colonne in lista_imprese
    for i in range(len(href_imprese)):                               #per i che va 0 fino alla lunghezza della lista href_imprese
        riga_elementi_liste = nomi_imprese[i], categorie_imprese[i], indirizzi_imprese[i], numeri_telefono_imprese[i], descrizioni_imprese[i], href_imprese[i] #aggiunge i dati nelle colonne in lista_imprese
        annuncio_riga_completa = ';'.join(riga_elementi_liste)       #unisci gli elementi i-esimi in una stringa con delimitatore ";"
        lista_imprese.append(annuncio_riga_completa)                 #aggiungi la stringa in lista_imprese 

    #leggo i dati dal file 'risultati_salvati.csv' e creo una lista di righe del file
    nomeFileCSV = nomeFile + '.csv'
    fileCSV = open(nomeFileCSV, 'a')
    os.chmod(nomeFileCSV, 0o644)  # Assegna i permessi di lettura e scrittura del file
    #crea una lista chiamata lista_annunci_fileCSV di righe dal file 'risultati_salvati.csv' senza il carattere '\n'
    lista_imprese_fileCSV = [riga.rstrip('\n') for riga in open(nomeFileCSV)] 

    #scrivo i dati che ho trovato nel sito solo se non sono contenuti nel file 'risultati_salvati.csv'
    new_link_imprese = []                                            #dichiaro la lista new_link_imprese
    for riga_impresa in lista_imprese:                               #per ogni elemento riga_impresa della lista lista_imprese
        if riga_impresa not in lista_imprese_fileCSV:                #se riga_ID_annuncio non è contenuta nella lista_ID_annunci
            new_link_imprese.append(riga_impresa)                    #allora aggiungo riga_impresa alla lista new_link_imprese
            fileCSV.write('%s\n' %riga_impresa)                      #e scrivo riga_impresa nel file fileCSV
    fileCSV.close()                                                  #chiudi il fileCSV
    #fileCSV.write('%s\n' % riga_impresa): significa che scrive all'interno del fileCSV, 
    #%s è un termine che sta per stringa e viene sostituito con il valore di riga_impresa 
    #%s\n perciò indica una stringa e subito dopo aggiunge il carattere va a capo
    if len(new_link_imprese) > 0:                                   #se la lunghezza della lista new_link_imprese è maggiore di 0
        print('Ci sono nuove imprese!')                             #stampa 'Ci sono nuovi imprese!'
        return True                                                 #ritorna True
    print('Nessuna nuova impresa.')                                 #altrimenti stampa 'Nessuna nuova impresa.'
    return False                                                    #ritorna False


#definizione funzione: controllo se il pulsante pagina successiva esiste
def controllaPulsantePagina(link, numeroPagina, nuoviDati):
    soup = bs4.BeautifulSoup(requests.get(link).text, 'html.parser')   #prende tutto l'html della pagina web
    classe_button_pagina_successiva = 'pag-next'                       #classe della pagina successiva
    button_pagina_successiva = soup.find('a', classe_button_pagina_successiva) #controlla se esiste 

    if button_pagina_successiva == None: #se il pulsante pagina successiva non esiste nella pagina html
        if nuoviDati == True:            #se ci sono nuovi dati
            print("Finito, ho preso i dati dalla pagina " + str(numeroPagina) + ", ultima pagina")     #stampa Finito, ho preso i dati dall'ultima pagina
        return True                      #ritorna True
    
    #se non è arrivato all'ultima pagina
    if nuoviDati == True:                #se ci sono nuovi dati
        print("Ho preso i dati dalla pagina " + str(numeroPagina))  #altrimenti stampa Ho preso i dati dalla pagina " + str(numeroPagina)
    return False                         #altrimenti ritorna False


#definizione funzione: converto il file csv in file xlsx, per una questione di lettura dati
def convertiFileCSVInXlsl(nomeFile):
    try:
        nomeFileCSV = nomeFile + '.csv'                 #aggiungo l'estensione .csv al nomeFile
        nomeFileXLSX = nomeFile + '.xlsx'               #aggiungo l'estensione .xlsx al nomeFile

        #verifica se il file risultati_salvati.xlsx esiste
        fileExcel = False
        if os.path.exists(nomeFileXLSX):
            fileExcel = True

        # legge il file CSV nomeFileCSV utilizzando pandas, con delimitatore ';' e con encoding ISO-8859-1
        df = pandas.read_csv(nomeFileCSV, delimiter=';', encoding='ISO-8859-1') #UTF-8 dà problemi di codifica
        #crea un oggetto ExcelWriter di pandas per scrivere i dati nel file nomeFileXLSX. Si specifica xlsxwriter come motore per la scrittura del file Excel.
        writer = pandas.ExcelWriter(nomeFileXLSX, engine='xlsxwriter')    
        #scrive i dati del DataFrame df nel file Excel utilizzando l'oggetto ExcelWriter
        #index=False per evitare di scrivere l'indice del DataFrame nel file Excel
        #specifica il nome del foglio in cui verranno scritti i dati (Foglio1)
        df.to_excel(writer, index=False, sheet_name='Foglio1')            
        workbook  = writer.book                                           # seleziona la cartella di lavoro excel
        worksheet = writer.sheets['Foglio1']                              # seleziona il 1°Foglio
    
        cell_format = workbook.add_format({'font_color': 'blue', 'underline': True})    #Aggiungi formattazione per rendere il link cliccabile
        worksheet.set_column('E:E', None, cell_format)              # Applica il formato alla colonna E che contiene i link

        #Setto la larghezza delle colonne e allineo al centro la colonna C e D
        format_center = workbook.add_format({'align': 'center'})        
        worksheet.set_column("A:A", 30) #colonna nome impresa
        worksheet.set_column("B:B", 37) #colonna categoria impresa
        worksheet.set_column("C:C", 55, format_center) #colonna indirizzo impresa
        worksheet.set_column("D:D", 15, format_center) #colonna numero impresa
        worksheet.set_column("E:E", 100) #colonna deescrizione impresa
        worksheet.set_column("F:F", 100) #colonna link impresa
        #se devo fare l'allineamento al centro e allargare la colonna, bisogna applicare entrambe le cose nella stesso comando,
        #altrimenti se sono separati sovrascrive il comando successivo a quello precedente

        worksheet.freeze_panes(1, 0)        # Blocca la prima riga
        writer._save()  #chiude il writer e salva il file

        #se il file risultati_salvati.xlsx esiste
        if fileExcel == True:
            print("Ho aggiornato il file xlsx")
        else:
            print("Ho creato il file xlsx corrispettivo, per leggere meglio i dati")

    except PermissionError:
        print("Non è possibile convertire il file csv in xlsx perchè il file è aperto in Excel, chiudilo")


#-----------------------------------Prendi i risultati di ricerca di tutte le pagine---------------------------------------------------------
LINK = "https://www.virgilio.it/italia/milano/cat/INFORMATICA_CONSULENZA_E_SOFTWARE"    #link 1°pagina 
LINKHTML = LINK + ".html"                                                               #aggiungi alla costante LINK '.html'
controlloStatoSito = verificaConnessioneSito(LINKHTML)                                  #controllo stato del sito
nomeFile = 'elenco_imprese_aggiornato'                                                  #nome del file che conterrà i dati

if controlloStatoSito == True:                                                          #se il sito risponde correttamente
    numeroPagina = 1                                                                    #dichiara la variabile numeroPagina                                              
    nuoviDati = prendiDati(LINKHTML, nomeFile)                                          #parte la funzione prendi_dati per LINK
    verificaStatoPulsante = controllaPulsantePagina(LINKHTML, numeroPagina, nuoviDati)  #verifica se il pulsante pagina successiva esiste

    while(verificaStatoPulsante == False):                                              #finchè verificaStatoPulsante è False
        numeroPagina += 1                                                               #aumenta numeroPagina di 1
        LINKMULTIPAGINE = LINK + "_(" + str(numeroPagina) + ").html?azi_eq_iq=c106f65d-56d6-4b48-b6cb-debab457ee32"  #link altre pagine successive alla 1° 
        nuoviDati = prendiDati(LINKMULTIPAGINE, nomeFile)                               #parte la funzione prendi_dati per LINKMULTIPAGINE
        verificaStatoPulsante = controllaPulsantePagina(LINKMULTIPAGINE, numeroPagina, nuoviDati) #verifica se il pulsante pagina successiva esiste

    convertiFileCSVInXlsl(nomeFile)                                                     #crea un file xlsx dal file csv
    print("Programma finito")

        </pre>
      </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  <script src="../../javascript/eventiPaginaProgetto.js"></script>
</body>

</html>